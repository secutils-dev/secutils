name: Secutils

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '*.md'
      - '.husky/**'
      - 'Dockerfile'
      - 'Dockerfile.aarch64-unknown-linux-musl'
      - 'Dockerfile.dockerignore'
      - 'Dockerfile.docs'
      - 'Dockerfile.docs.dockerignore'
      - 'Dockerfile.webui'
      - 'Dockerfile.webui.dockerignore'
      - 'LICENSE'
      - 'dev/**'

env:
  CARGO_TERM_COLOR: always
  DATABASE_URL: postgres://postgres@localhost:5432/secutils

jobs:
  ci-api:
    name: Build API (Linux)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust: [ stable ]
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true

      - name: Install Protoc
        uses: arduino/setup-protoc@v3

      # Always install nightly toolchain for `Rustfmt`.
      - name: Install toolchain ${{ matrix.rust }}
        run: |
          rustup toolchain install ${{ matrix.rust }} nightly
          rustup override set ${{ matrix.rust }}
          rustup component add clippy
          rustup component add --toolchain nightly rustfmt

      - name: Cache Dependencies
        uses: Swatinem/rust-cache@v2

      - name: Check format
        run: cargo +nightly fmt --all -- --check

      - name: Check database schema
        run: |
          cargo install --locked --force sqlx-cli
          cargo sqlx database create
          cargo sqlx migrate run
          cargo sqlx prepare --check

      - name: Test (default features)
        run: cargo test

      - name: Build (default features)
        run: cargo build --workspace --release

      - name: Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

  ci-webui:
    name: Build Web UI (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm --prefix components/secutils-webui ci

      - name: Build
        run: npm --prefix components/secutils-webui run build

  ci-docs:
    name: Build Docs (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm --prefix components/secutils-docs ci

      - name: Build
        run: npm --prefix components/secutils-docs run build

  ci-e2e:
    name: E2E Tests (Linux)
    runs-on: ubuntu-latest
    needs: [ci-api, ci-webui]
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Install Playwright
        working-directory: e2e
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Start services
        run: docker compose -f dev/docker/docker-compose.ci-cache.yml up -d --build --wait

      - name: Wait for services to be ready
        run: |
          echo "Waiting for Secutils API..."
          for i in $(seq 1 60); do
            if curl -sf http://localhost:7070/api/status > /dev/null 2>&1; then
              echo "API is ready"
              break
            fi
            echo "Attempt $i/60..."
            sleep 5
          done

          echo "Waiting for WebUI..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:7171/ > /dev/null 2>&1; then
              echo "WebUI is ready"
              break
            fi
            echo "Attempt $i/30..."
            sleep 5
          done

      - name: Run Playwright tests
        working-directory: e2e
        run: npx playwright test
        env:
          BASE_URL: http://localhost:7171

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 14

      - name: Collect Docker logs on failure
        if: failure()
        run: docker compose -f dev/docker/docker-compose.ci-cache.yml logs > docker-logs.txt 2>&1

      - name: Upload Docker logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: docker-logs
          path: docker-logs.txt
          retention-days: 7

      - name: Stop services
        if: always()
        run: docker compose -f dev/docker/docker-compose.ci-cache.yml down --volumes
